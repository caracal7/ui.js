<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ui.js stage1 examples</title>
    <link rel="icon" href="../favicon.ico" type="image/x-icon"/>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="../src/index.js"></script>
    <style>
        html, body { padding: 0; margin: 0; height: 100% }
    </style>
</head>

<body>
    <script type=ui monaco-editor='examples/integrations/monaco-editor/ui-monaco/monaco-editor'></script>

    <script type=ui>
        <!import MENU from menu-json.js>

        <!state>
            default: 'euer/letters.html',
            menu: [],
            selected_example: undefined,

            source: '',
            url: undefined,
            files: []

        <!tag @side-menu tags/side-menu>
        <!tag @tabs tags/tabs>
        <!tag @download-link tags/download-link>
        <!tag @download-example tags/download-example>



        <!template>
            <@side-menu id='menu' menu=state.menu @select>
                <@tabs id='tabs' fullheight>
                    <article caption="Result" caption-css="font-weight:bold" style="overflow:hidden">
                        <iframe sandbox="allow-forms allow-modals allow-popups allow-scripts allow-same-origin" frameborder=0/>
                    </article>
                    <article
                        if(state.selected_example)
                        loop(state.selected_example.urls as file, ind | (d,i) => i)
                        caption=(file.split("/").pop())>
                        <monaco-editor
                            value=((state.selected_example.sources && state.selected_example.sources[ind]) || "Loading...")
                            read-only
                            filename=file/>
                    </article>
                    <article if(isExternals(state.selected_example)) caption='Externals' caption-css="font-weight:bold">
                        <ul if(Array.isArray(state.selected_example.externals))>
                            <li loop(state.selected_example.externals as file, ind|d => d)>
                                <@download-link
                                    href=(state.selected_example.base + '/' + file)
                                    filename=(file.split("/").pop())
                                    text(file.split("/").pop())/>
                            </li>
                        </ul>
                        <div style='padding:10px'
                            if(!Array.isArray(state.selected_example.externals))
                            loop(Object.keys(state.selected_example.externals) as folder|d => d)>
                            <h2 text(folder)/>
                            <ul>
                                <li loop(state.selected_example.externals[folder] as file, ind|d => d)>
                                    <@download-link
                                        href=(state.selected_example.base + '/' + file)
                                        filename=(file.split("/").pop())
                                        text(file.split("/").pop())/>
                                </li>
                            </ul>
                        </div>
                    </article>
                </@tabs>
            </@side-menu>

            <@download-example if(state.selected_example) example=state.selected_example/>

        <!static>
            function isExternals(selected_example) {
                if(!selected_example || !selected_example.externals) return;
                if(Array.isArray(selected_example.externals) && selected_example.externals.length) return true;
                if(Object.keys(selected_example.externals).length) return true;
            }

            function splitLast(str, substring) {
                const index = str.lastIndexOf(substring);
                return [ str.slice(0, index), str.slice(index + 1) ];
            }

            const base = splitLast(window.location.pathname, '/')[0].substr(1) + '/';

        <!class>
            async load2iframe(url) {
                if(url.substr(-4) === '.tag') {
                    this.$('iframe').removeAttribute('src');
                    this.$('iframe').srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <meta name="viewport" content="width=device-width,initial-scale=1.0">
                        <`+`script type="module" src="../src/index.js"></`+`script>
                        <style>html, body { padding: 0; margin: 0; height: 100%; }</style>
                    </head>
                    <body>
                        <`+`script type=ui example-app="${base + url}"></`+`script>
                        <example-app></example-app>
                    </body>
                    </html>`;
                } else {
                    this.$('iframe').removeAttribute('srcdoc');
                    this.$('iframe').src = url;
                }
            }

            async loadExample(example) {

                const ex = this.state.selected_example.base + '/' + this.state.selected_example.urls[0];

                if(history.pushState) history.pushState(null, null, '#'+ex);
                else location.hash = '#myhash'+ex;

                await this.load2iframe('examples/' + ex);
                if(!example.sources) example.sources = [];
                for (const [index, file] of example.urls.entries()) {
                    if(example.sources[index]) continue;
                    const src = await fetch('examples/' + this.state.selected_example.base + '/' + file).catch(e => false);
                    if(src === false) throw 'Error loading ' + url;
                    const source = (await src.text()).trim()
                        .replaceAll(/<script id="__bs_script__.*\/\/]]><\/script>/gs, "") // remove browserSync
                        .replaceAll(/<script type="module" src="\.\.\/\.\.\/\.\.\/src\/index\.js"><\/script>/gs, '<'+'script src="ui.js"></'+'script>')
                        .replaceAll(/<script type="module" src="\.\.\/\.\.\/src\/index\.js"><\/script>/gs, '<'+'script src="ui.js"></'+'script>');
                    example.sources.push(source);
                }
                this.render();
            }

            findExample(base, url) {
                function Find(arr, url) {
                    var found, _;
                    arr.some(item => (item.submenu && (_ = Find(item.submenu, url))) ? (found = _) : item.base == base && item.urls && item.urls.includes(url) && (found = item));
                    return found;
                }
                return Find(this.state.menu, url);
            }

            async connected() {
                this.state.menu = MENU;
                // wait 0,5 sec while animation is done before load example
                await new Promise(r => setTimeout(r, 500));

                const loadExampleFromHash = async () => {
                    const ex = this.findExample(...splitLast(window.location.hash.substr(1), '/'));
                    this.state.selected_example = ex || this.findExample(...splitLast(this.state.default, '/'));
                    await this.loadExample(this.state.selected_example);
                }
                this.on('hashchange', loadExampleFromHash);
                loadExampleFromHash();
            }

            async select(event) {
                this.state.selected_example = event.detail;
                await this.loadExample(this.state.selected_example);
            }

        <!style>
            ui-accordion {
                position: absolute;
                width: calc(100% - 240px);
                height: 100%;
                right:0;
            }

            iframe {
                box-sizing: border-box;
                width: 100%;
                height: 100%;
            }


    </script>



</body>

</html>
